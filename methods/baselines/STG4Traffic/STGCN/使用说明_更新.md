# STGCN预测结果NPY文件生成脚本 - 使用说明

## 快速开始

### 使用默认设置（CUDA:0）
```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py
```

### 使用CUDA:1（推荐用于你的情况）
```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py --device cuda:1
```

### 使用CPU
```bash
python3 run_generate_predictions.py --device cpu
```

### 自定义批次大小
```bash
python3 run_generate_predictions.py --device cuda:1 --batch_size 32
```

### 自定义输出目录
```bash
python3 run_generate_predictions.py --device cuda:1 --output_dir ./my_predictions
```

## 命令行参数

`run_generate_predictions.py` 支持以下参数：

- `--device` : 使用的设备 (默认: cuda:0)
  - `cuda:0` - 使用第一块GPU
  - `cuda:1` - 使用第二块GPU
  - `cpu` - 使用CPU

- `--batch_size` : 批次大小 (默认: 64)
  - 如果GPU内存不足，可以减小这个值

- `--output_dir` : 输出目录 (默认: ./predictions_npy)
  - 所有NPY文件将保存在这个目录

## 修复的问题

1. **修复了 `source` 命令错误**
   - 原因：默认的 `/bin/sh` 不支持 `source` 命令
   - 解决：明确使用 `/bin/bash` 来执行命令

2. **添加了设备选择支持**
   - 现在可以通过 `--device` 参数指定使用哪个GPU
   - 支持 `cuda:0`, `cuda:1`, `cpu` 等

## 单独运行某个数据集

如果你只想生成某个数据集的预测：

```bash
# 激活环境
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate stg4t

# 只运行PEMSBAY（使用CUDA:1）
python generate_predictions_npy.py --dataset PEMSBAY --device cuda:1

# 只运行METRLA（使用CUDA:1）
python generate_predictions_npy.py --dataset METRLA --device cuda:1
```

## 输出文件

运行后会在指定的输出目录生成4个文件：

### PEMSBAY数据集
1. `stgcn_pemsbay_predictions.npy` - STGCN模型预测
   - 形状: (144, num_samples, 325)

2. `pemsbay_ground_truth.npy` - 真实值
   - 形状: (144, num_samples, 325)

### METRLA数据集
3. `stgcn_metrla_predictions.npy` - STGCN模型预测
   - 形状: (144, num_samples, 207)

4. `metrla_ground_truth.npy` - 真实值
   - 形状: (144, num_samples, 207)

## 预期输出

```
Working directory: /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN

================================================================================
STGCN Prediction NPY Generator
================================================================================
Device: cuda:1
Batch size: 64
Output directory: ./predictions_npy

================================================================================
Generating predictions for PEMSBAY...
================================================================================
Running: source /opt/miniconda3/etc/profile.d/conda.sh && conda activate stg4t && python generate_predictions_npy.py --dataset PEMSBAY --device cuda:1 --batch_size 64 --output_dir ./predictions_npy

================================================================================
STGCN Prediction NPY Generator
================================================================================
Dataset: PEMSBAY
Device: cuda:1
Num Nodes: 325
Window: 144
Horizon: 144
Output Dir: ./predictions_npy
================================================================================

Loading data...
Data loaded successfully!

Generating model...
Model generated successfully!

Using model: ../log/STGCN/PEMSBAY/20251229012414/PEMSBAY_STGCN_best_model.pth

Generating predictions...
  Processed time step 12/144
  Processed time step 24/144
  ...
  Processed time step 144/144

Predictions shape: (144, 5209, 325)
Ground truth shape: (144, 5209, 325)
Data type: float32

Format verification:
  seq_length (horizon): 144
  num_samples: 5209
  num_nodes: 325

Overall Metrics:
  MAE:  1.2345
  RMSE: 2.3456
  MAPE: 3.45%

Saving NPY files...

Saved predictions to: ./predictions_npy/stgcn_pemsbay_predictions.npy
Saved ground truth to: ./predictions_npy/pemsbay_ground_truth.npy

✓ PEMSBAY predictions generated successfully

================================================================================
Generating predictions for METRLA...
================================================================================
[类似的输出...]

✓ METRLA predictions generated successfully

================================================================================
Summary
================================================================================
✓ All predictions generated successfully!

Output files in ./predictions_npy:
-rw-r--r-- 1 xiaoxiao mlusers 965M Jan 20 03:30 stgcn_pemsbay_predictions.npy
-rw-r--r-- 1 xiaoxiao mlusers 965M Jan 20 03:30 pemsbay_ground_truth.npy
-rw-r--r-- 1 xiaoxiao mlusers 614M Jan 20 03:35 stgcn_metrla_predictions.npy
-rw-r--r-- 1 xiaoxiao mlusers 614M Jan 20 03:35 metrla_ground_truth.npy
```

## 常见问题

### 1. CUDA内存不足
```bash
# 减小批次大小
python3 run_generate_predictions.py --device cuda:1 --batch_size 32
```

### 2. 想使用不同的GPU
```bash
# 使用第二块GPU
python3 run_generate_predictions.py --device cuda:1

# 使用第一块GPU
python3 run_generate_predictions.py --device cuda:0
```

### 3. 检查GPU使用情况
```bash
nvidia-smi
```

### 4. 找不到模型文件
手动指定模型路径：
```bash
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate stg4t

python generate_predictions_npy.py \
    --dataset PEMSBAY \
    --model_path /完整/路径/到/model.pth \
    --device cuda:1
```

## 加载生成的NPY文件

```python
import numpy as np

# 加载预测结果
pemsbay_pred = np.load('predictions_npy/stgcn_pemsbay_predictions.npy')
pemsbay_gt = np.load('predictions_npy/pemsbay_ground_truth.npy')

metrla_pred = np.load('predictions_npy/stgcn_metrla_predictions.npy')
metrla_gt = np.load('predictions_npy/metrla_ground_truth.npy')

# 查看形状
print(f"PEMSBAY预测: {pemsbay_pred.shape}")  # (144, num_samples, 325)
print(f"METRLA预测: {metrla_pred.shape}")    # (144, num_samples, 207)

# 计算MAE
mae_pemsbay = np.mean(np.abs(pemsbay_pred - pemsbay_gt))
mae_metrla = np.mean(np.abs(metrla_pred - metrla_gt))
print(f"PEMSBAY MAE: {mae_pemsbay:.4f}")
print(f"METRLA MAE: {mae_metrla:.4f}")
```

## 现在就开始

使用CUDA:1运行：
```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py --device cuda:1
```
