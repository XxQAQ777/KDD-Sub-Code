# STGCN预测结果NPY文件生成脚本

## 概述

已创建完整的脚本系统，用于生成符合规格要求的STGCN模型预测结果NPY文件。

## 创建的文件

1. **`generate_predictions_npy.py`** (12KB) - 主要生成脚本
   - 加载训练好的STGCN模型
   - 生成预测结果
   - 保存为NPY格式
   - 自动反归一化到真实值

2. **`run_generate_predictions.py`** (2.3KB) - Python包装脚本
   - 自动激活conda环境
   - 依次运行PEMSBAY和METRLA数据集
   - 最简单的使用方式

3. **`generate_all_predictions.sh`** (1.7KB) - Bash脚本
   - 与Python包装脚本功能相同
   - 适合喜欢使用shell的用户

4. **`QUICKSTART.md`** (3.6KB) - 快速开始指南
   - 最简单的使用说明
   - 常见问题解决

5. **`README_NPY_GENERATION.md`** (6.4KB) - 详细文档
   - 完整的使用说明
   - 所有命令行参数
   - 详细的示例输出

## 输出格式（符合规格要求）

所有生成的NPY文件格式：
- **维度**: `(seq_length, num_samples, num_nodes)`
  - `seq_length`: 144（预测时间步数）
  - `num_samples`: 测试样本数量
  - `num_nodes`: 节点数量（PEMSBAY=325, METRLA=207）
- **数据类型**: float32或float64
- **数值**: 反归一化后的真实值（实际交通速度）

## 生成的文件

运行后会在 `./predictions_npy/` 目录生成4个文件：

### PEMSBAY数据集
1. `stgcn_pemsbay_predictions.npy` - STGCN模型预测
   - 形状: (144, num_samples, 325)

2. `pemsbay_ground_truth.npy` - 真实值
   - 形状: (144, num_samples, 325)

### METRLA数据集
3. `stgcn_metrla_predictions.npy` - STGCN模型预测
   - 形状: (144, num_samples, 207)

4. `metrla_ground_truth.npy` - 真实值
   - 形状: (144, num_samples, 207)

## 使用方法

### 最简单的方式（推荐）

```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py
```

这个命令会：
1. 自动激活stg4t conda环境
2. 自动找到训练好的模型
3. 生成PEMSBAY的预测结果
4. 生成METRLA的预测结果
5. 保存所有4个NPY文件

### 单独运行某个数据集

```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate stg4t

# 只运行PEMSBAY
python generate_predictions_npy.py --dataset PEMSBAY --device cuda:0

# 只运行METRLA
python generate_predictions_npy.py --dataset METRLA --device cuda:0
```

### 指定自定义模型路径

```bash
python generate_predictions_npy.py \
    --dataset PEMSBAY \
    --model_path /path/to/your/model.pth \
    --device cuda:0 \
    --output_dir ./my_predictions
```

## 使用的训练模型

脚本会自动使用以下训练好的模型：
- **PEMSBAY**: `../log/STGCN/PEMSBAY/20251229012414/PEMSBAY_STGCN_best_model.pth`
- **METRLA**: `../log/STGCN/METRLA/20251229023643/METRLA_STGCN_best_model.pth`

## 脚本特点

1. **完全遵循test_and_plot.py的方式**
   - 使用相同的模型加载方法
   - 使用相同的数据加载方法
   - 使用相同的配置文件读取方式

2. **自动化程度高**
   - 自动检测最新的模型文件
   - 自动激活conda环境
   - 自动创建输出目录

3. **输出信息详细**
   - 显示每个时间步的处理进度
   - 显示生成的文件信息（形状、大小、数值范围）
   - 显示整体评估指标（MAE、RMSE、MAPE）

4. **格式验证**
   - 自动验证输出格式是否符合规格
   - 显示维度信息确认正确

## 加载生成的NPY文件

```python
import numpy as np

# 加载预测结果
pemsbay_pred = np.load('predictions_npy/stgcn_pemsbay_predictions.npy')
pemsbay_gt = np.load('predictions_npy/pemsbay_ground_truth.npy')

metrla_pred = np.load('predictions_npy/stgcn_metrla_predictions.npy')
metrla_gt = np.load('predictions_npy/metrla_ground_truth.npy')

# 查看形状
print(f"PEMSBAY预测: {pemsbay_pred.shape}")  # (144, num_samples, 325)
print(f"METRLA预测: {metrla_pred.shape}")    # (144, num_samples, 207)

# 访问特定时间步
time_step = 0
pred_t0 = pemsbay_pred[time_step]  # 形状: (num_samples, 325)

# 访问特定样本
sample_idx = 0
pred_sample = pemsbay_pred[:, sample_idx, :]  # 形状: (144, 325)

# 访问特定节点
node_idx = 0
pred_node = pemsbay_pred[:, :, node_idx]  # 形状: (144, num_samples)
```

## 常见问题

### 1. CUDA内存不足
减小批次大小：
```bash
python generate_predictions_npy.py --dataset PEMSBAY --batch_size 32
```

或使用CPU：
```bash
python generate_predictions_npy.py --dataset PEMSBAY --device cpu
```

### 2. 找不到模型文件
手动指定模型路径：
```bash
python generate_predictions_npy.py \
    --dataset PEMSBAY \
    --model_path /完整/路径/到/model.pth
```

### 3. 环境问题
确保使用stg4t环境：
```bash
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate stg4t
which python  # 应该显示stg4t环境的python
```

## 预期输出示例

```
================================================================================
STGCN Prediction NPY Generator
================================================================================
Dataset: PEMSBAY
Device: cuda:0
Num Nodes: 325
Window: 144
Horizon: 144
Output Dir: ./predictions_npy
================================================================================

Loading data...
Data loaded successfully!

Generating model...
Model generated successfully!

Using model: ../log/STGCN/PEMSBAY/20251229012414/PEMSBAY_STGCN_best_model.pth

Generating predictions...
  Processed time step 12/144
  Processed time step 24/144
  ...
  Processed time step 144/144

Predictions shape: (144, 5209, 325)
Ground truth shape: (144, 5209, 325)
Data type: float32

Format verification:
  seq_length (horizon): 144
  num_samples: 5209
  num_nodes: 325

Overall Metrics:
  MAE:  1.2345
  RMSE: 2.3456
  MAPE: 3.45%

Saving NPY files...

Saved predictions to: ./predictions_npy/stgcn_pemsbay_predictions.npy
Saved ground truth to: ./predictions_npy/pemsbay_ground_truth.npy

File information:
  Predictions file: stgcn_pemsbay_predictions.npy
    - Shape: (144, 5209, 325)
    - Dtype: float32
    - Size: 965.23 MB
    - Value range: [0.00, 75.50]

================================================================================
NPY generation completed successfully!
Files saved to: ./predictions_npy
================================================================================
```

## 文件位置

所有脚本位于：
```
/home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN/
```

生成的NPY文件将保存在：
```
/home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN/predictions_npy/
```

## 下一步

运行以下命令开始生成预测结果：

```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py
```

生成完成后，你将得到4个符合规格要求的NPY文件，可以直接用于后续分析。
