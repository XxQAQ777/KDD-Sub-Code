# STGCN预测NPY生成 - 快速开始（所有问题已修复）

## 立即运行

所有问题已修复，现在可以直接运行：

```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py --device cuda:1
```

## 已修复的所有问题

1. ✅ **`source: not found` 错误**
   - 修复：使用 `/bin/bash` 而不是默认的 `/bin/sh`

2. ✅ **设备选择问题**
   - 修复：添加 `--device` 参数支持

3. ✅ **环境依赖问题（numpy/pandas版本冲突）**
   - 修复：使用系统默认python环境而不是stg4t环境

4. ✅ **数据路径错误**
   - 修复：将 `../../data/` 改为 `../data/`

## 使用方法

### 基本用法（推荐）
```bash
# 使用CUDA:1生成所有预测
python3 run_generate_predictions.py --device cuda:1
```

### 其他选项
```bash
# 使用CUDA:0（默认）
python3 run_generate_predictions.py

# 使用CPU
python3 run_generate_predictions.py --device cpu

# 减小批次大小（如果GPU内存不足）
python3 run_generate_predictions.py --device cuda:1 --batch_size 32

# 自定义输出目录
python3 run_generate_predictions.py --device cuda:1 --output_dir ./my_predictions
```

### 单独运行某个数据集
```bash
# 只运行PEMSBAY
python generate_predictions_npy.py --dataset PEMSBAY --device cuda:1

# 只运行METRLA
python generate_predictions_npy.py --dataset METRLA --device cuda:1
```

## 输出文件

运行后会在 `./predictions_npy/` 目录生成4个NPY文件：

### PEMSBAY数据集
1. **`stgcn_pemsbay_predictions.npy`**
   - 形状: (144, num_samples, 325)
   - STGCN模型预测结果

2. **`pemsbay_ground_truth.npy`**
   - 形状: (144, num_samples, 325)
   - 真实值

### METRLA数据集
3. **`stgcn_metrla_predictions.npy`**
   - 形状: (144, num_samples, 207)
   - STGCN模型预测结果

4. **`metrla_ground_truth.npy`**
   - 形状: (144, num_samples, 207)
   - 真实值

## 格式说明

所有NPY文件符合规格要求：
- **维度**: `(seq_length, num_samples, num_nodes)`
  - `seq_length`: 144（预测时间步数）
  - `num_samples`: 测试样本数量
  - `num_nodes`: 325（PEMSBAY）或 207（METRLA）
- **数据类型**: float32或float64
- **数值**: 反归一化后的真实交通速度值

## 预期运行时间

- PEMSBAY: 约5-10分钟（取决于GPU）
- METRLA: 约3-5分钟（取决于GPU）
- 总计: 约8-15分钟

## 预期输出示例

```
Working directory: /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN

================================================================================
STGCN Prediction NPY Generator
================================================================================
Device: cuda:1
Batch size: 64
Output directory: ./predictions_npy

================================================================================
Generating predictions for PEMSBAY...
================================================================================
Running: python generate_predictions_npy.py --dataset PEMSBAY --device cuda:1 --batch_size 64 --output_dir ./predictions_npy

================================================================================
STGCN Prediction NPY Generator
================================================================================
Dataset: PEMSBAY
Device: cuda:1
Num Nodes: 325
Window: 144
Horizon: 144
Output Dir: ./predictions_npy
================================================================================

Loading data...
Data loaded successfully!

Generating model...
Model generated successfully!

Using model: ../log/STGCN/PEMSBAY/20251229012414/PEMSBAY_STGCN_best_model.pth

Generating predictions...
  Processed time step 12/144
  Processed time step 24/144
  Processed time step 36/144
  ...
  Processed time step 144/144

Predictions shape: (144, 5209, 325)
Ground truth shape: (144, 5209, 325)
Data type: float32

Format verification:
  seq_length (horizon): 144
  num_samples: 5209
  num_nodes: 325

Overall Metrics:
  MAE:  1.2345
  RMSE: 2.3456
  MAPE: 3.45%

Saving NPY files...

Saved predictions to: ./predictions_npy/stgcn_pemsbay_predictions.npy
Saved ground truth to: ./predictions_npy/pemsbay_ground_truth.npy

File information:
  Predictions file: stgcn_pemsbay_predictions.npy
    - Shape: (144, 5209, 325)
    - Dtype: float32
    - Size: 965.23 MB
    - Value range: [0.00, 75.50]

  Ground truth file: pemsbay_ground_truth.npy
    - Shape: (144, 5209, 325)
    - Dtype: float32
    - Size: 965.23 MB
    - Value range: [0.00, 75.50]

================================================================================
NPY generation completed successfully!
Files saved to: ./predictions_npy
================================================================================

✓ PEMSBAY predictions generated successfully

================================================================================
Generating predictions for METRLA...
================================================================================
[类似的输出...]

✓ METRLA predictions generated successfully

================================================================================
Summary
================================================================================
✓ All predictions generated successfully!

Output files in ./predictions_npy:
-rw-r--r-- 1 xiaoxiao mlusers 965M Jan 20 04:30 stgcn_pemsbay_predictions.npy
-rw-r--r-- 1 xiaoxiao mlusers 965M Jan 20 04:30 pemsbay_ground_truth.npy
-rw-r--r-- 1 xiaoxiao mlusers 614M Jan 20 04:35 stgcn_metrla_predictions.npy
-rw-r--r-- 1 xiaoxiao mlusers 614M Jan 20 04:35 metrla_ground_truth.npy
```

## 加载和使用生成的文件

```python
import numpy as np

# 加载预测结果
pemsbay_pred = np.load('predictions_npy/stgcn_pemsbay_predictions.npy')
pemsbay_gt = np.load('predictions_npy/pemsbay_ground_truth.npy')

metrla_pred = np.load('predictions_npy/stgcn_metrla_predictions.npy')
metrla_gt = np.load('predictions_npy/metrla_ground_truth.npy')

# 验证形状
print(f"PEMSBAY预测形状: {pemsbay_pred.shape}")  # (144, 5209, 325)
print(f"METRLA预测形状: {metrla_pred.shape}")    # (144, num_samples, 207)

# 计算整体MAE
mae_pemsbay = np.mean(np.abs(pemsbay_pred - pemsbay_gt))
mae_metrla = np.mean(np.abs(metrla_pred - metrla_gt))
print(f"PEMSBAY MAE: {mae_pemsbay:.4f}")
print(f"METRLA MAE: {mae_metrla:.4f}")

# 访问特定时间步的预测
time_step = 0  # 第一个时间步
pred_t0 = pemsbay_pred[time_step]  # 形状: (num_samples, 325)

# 访问特定样本的时间序列
sample_idx = 0  # 第一个样本
pred_sample = pemsbay_pred[:, sample_idx, :]  # 形状: (144, 325)

# 访问特定节点的所有预测
node_idx = 0  # 第一个节点
pred_node = pemsbay_pred[:, :, node_idx]  # 形状: (144, num_samples)
```

## 常见问题

### GPU内存不足
```bash
python3 run_generate_predictions.py --device cuda:1 --batch_size 32
```

### 检查GPU状态
```bash
nvidia-smi
```

### 查看生成的文件
```bash
ls -lh predictions_npy/
```

### 验证文件格式
```python
import numpy as np
data = np.load('predictions_npy/stgcn_pemsbay_predictions.npy')
print(f"Shape: {data.shape}")
print(f"Dtype: {data.dtype}")
print(f"Range: [{data.min():.2f}, {data.max():.2f}]")
```

## 现在就开始！

```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py --device cuda:1
```

所有问题已修复，脚本已准备就绪！
