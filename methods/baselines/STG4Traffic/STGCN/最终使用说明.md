# STGCN预测结果NPY文件生成 - 最终使用说明

## 环境问题已解决

**问题**: `stg4t` conda环境的numpy和pandas版本不兼容
**解决**: 使用系统默认的python环境（已验证可用）

## 快速开始

### 使用CUDA:1（推荐）
```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py --device cuda:1
```

### 使用CUDA:0（默认）
```bash
python3 run_generate_predictions.py
```

### 使用CPU
```bash
python3 run_generate_predictions.py --device cpu
```

## 命令行参数

- `--device` : 设备选择 (默认: cuda:0)
  - `cuda:0` - 第一块GPU
  - `cuda:1` - 第二块GPU
  - `cpu` - CPU

- `--batch_size` : 批次大小 (默认: 64)
  - 如果GPU内存不足，可以减小

- `--output_dir` : 输出目录 (默认: ./predictions_npy)

## 示例命令

```bash
# 使用CUDA:1，默认批次大小
python3 run_generate_predictions.py --device cuda:1

# 使用CUDA:1，减小批次大小
python3 run_generate_predictions.py --device cuda:1 --batch_size 32

# 使用CUDA:1，自定义输出目录
python3 run_generate_predictions.py --device cuda:1 --output_dir ./my_predictions

# 使用CPU
python3 run_generate_predictions.py --device cpu
```

## 单独运行某个数据集

```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN

# 只运行PEMSBAY
python generate_predictions_npy.py --dataset PEMSBAY --device cuda:1

# 只运行METRLA
python generate_predictions_npy.py --dataset METRLA --device cuda:1
```

## 输出文件

运行后会在 `./predictions_npy/` 目录生成4个文件：

### PEMSBAY数据集
1. **`stgcn_pemsbay_predictions.npy`** - STGCN模型预测
   - 形状: (144, num_samples, 325)
   - 数据类型: float32/float64
   - 数值: 反归一化后的真实交通速度

2. **`pemsbay_ground_truth.npy`** - 真实值
   - 形状: (144, num_samples, 325)

### METRLA数据集
3. **`stgcn_metrla_predictions.npy`** - STGCN模型预测
   - 形状: (144, num_samples, 207)

4. **`metrla_ground_truth.npy`** - 真实值
   - 形状: (144, num_samples, 207)

## 格式说明

所有NPY文件格式：
- **维度**: `(seq_length, num_samples, num_nodes)`
  - `seq_length`: 144（预测时间步数）
  - `num_samples`: 测试样本数量
  - `num_nodes`: 节点数量（PEMSBAY=325, METRLA=207）
- **数据类型**: float32或float64
- **数值**: 反归一化后的真实值（实际交通速度）

## 预期输出

```
Working directory: /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN

================================================================================
STGCN Prediction NPY Generator
================================================================================
Device: cuda:1
Batch size: 64
Output directory: ./predictions_npy

================================================================================
Generating predictions for PEMSBAY...
================================================================================
Running: python generate_predictions_npy.py --dataset PEMSBAY --device cuda:1 --batch_size 64 --output_dir ./predictions_npy

================================================================================
STGCN Prediction NPY Generator
================================================================================
Dataset: PEMSBAY
Device: cuda:1
Num Nodes: 325
Window: 144
Horizon: 144
Output Dir: ./predictions_npy
================================================================================

Loading data...
Data loaded successfully!

Generating model...
Model generated successfully!

Using model: ../log/STGCN/PEMSBAY/20251229012414/PEMSBAY_STGCN_best_model.pth

Generating predictions...
  Processed time step 12/144
  Processed time step 24/144
  ...
  Processed time step 144/144

Predictions shape: (144, 5209, 325)
Ground truth shape: (144, 5209, 325)
Data type: float32

Format verification:
  seq_length (horizon): 144
  num_samples: 5209
  num_nodes: 325

Overall Metrics:
  MAE:  1.2345
  RMSE: 2.3456
  MAPE: 3.45%

Saving NPY files...

Saved predictions to: ./predictions_npy/stgcn_pemsbay_predictions.npy
Saved ground truth to: ./predictions_npy/pemsbay_ground_truth.npy

File information:
  Predictions file: stgcn_pemsbay_predictions.npy
    - Shape: (144, 5209, 325)
    - Dtype: float32
    - Size: 965.23 MB
    - Value range: [0.00, 75.50]

  Ground truth file: pemsbay_ground_truth.npy
    - Shape: (144, 5209, 325)
    - Dtype: float32
    - Size: 965.23 MB
    - Value range: [0.00, 75.50]

================================================================================
NPY generation completed successfully!
Files saved to: ./predictions_npy
================================================================================

✓ PEMSBAY predictions generated successfully

================================================================================
Generating predictions for METRLA...
================================================================================
[类似的输出...]

✓ METRLA predictions generated successfully

================================================================================
Summary
================================================================================
✓ All predictions generated successfully!

Output files in ./predictions_npy:
-rw-r--r-- 1 xiaoxiao mlusers 965M Jan 20 04:00 stgcn_pemsbay_predictions.npy
-rw-r--r-- 1 xiaoxiao mlusers 965M Jan 20 04:00 pemsbay_ground_truth.npy
-rw-r--r-- 1 xiaoxiao mlusers 614M Jan 20 04:05 stgcn_metrla_predictions.npy
-rw-r--r-- 1 xiaoxiao mlusers 614M Jan 20 04:05 metrla_ground_truth.npy
```

## 加载生成的NPY文件

```python
import numpy as np

# 加载预测结果
pemsbay_pred = np.load('predictions_npy/stgcn_pemsbay_predictions.npy')
pemsbay_gt = np.load('predictions_npy/pemsbay_ground_truth.npy')

metrla_pred = np.load('predictions_npy/stgcn_metrla_predictions.npy')
metrla_gt = np.load('predictions_npy/metrla_ground_truth.npy')

# 查看形状
print(f"PEMSBAY预测: {pemsbay_pred.shape}")  # (144, num_samples, 325)
print(f"METRLA预测: {metrla_pred.shape}")    # (144, num_samples, 207)

# 计算MAE
mae_pemsbay = np.mean(np.abs(pemsbay_pred - pemsbay_gt))
mae_metrla = np.mean(np.abs(metrla_pred - metrla_gt))
print(f"PEMSBAY MAE: {mae_pemsbay:.4f}")
print(f"METRLA MAE: {mae_metrla:.4f}")

# 访问特定时间步
time_step = 0
pred_t0 = pemsbay_pred[time_step]  # 形状: (num_samples, 325)

# 访问特定样本
sample_idx = 0
pred_sample = pemsbay_pred[:, sample_idx, :]  # 形状: (144, 325)

# 访问特定节点
node_idx = 0
pred_node = pemsbay_pred[:, :, node_idx]  # 形状: (144, num_samples)
```

## 常见问题

### 1. CUDA内存不足
```bash
# 减小批次大小
python3 run_generate_predictions.py --device cuda:1 --batch_size 32
```

### 2. 检查GPU使用情况
```bash
nvidia-smi
```

### 3. 找不到模型文件
手动指定模型路径：
```bash
python generate_predictions_npy.py \
    --dataset PEMSBAY \
    --model_path /完整/路径/到/model.pth \
    --device cuda:1
```

### 4. 环境问题
脚本现在使用系统默认的python环境，不需要激活conda环境。
确保你在正确的目录：
```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
which python  # 应该显示 /opt/miniconda3/bin/python
```

## 修复的问题

1. ✅ 修复了 `source: not found` 错误（使用 `/bin/bash`）
2. ✅ 添加了设备选择支持（`--device` 参数）
3. ✅ 修复了环境依赖问题（使用系统默认python而不是stg4t环境）

## 现在就开始

使用CUDA:1运行：
```bash
cd /home/xiaoxiao/FlowGNN/STG4Traffic-main/TrafficSpeed/STGCN
python3 run_generate_predictions.py --device cuda:1
```

这将生成所有4个符合规格要求的NPY文件！
